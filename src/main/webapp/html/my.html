<!DOCTYPE html>
<html lang="en">
<head>
    <title>RPG</title>
    <meta charset="UTF-8">
    <link href="/css/my.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!--    <script defer src="/javaScript/my.js"></script>-->
</head>
<body>
<h1>RPG admin panel</h1>
<h2>Accounts list:</h2>

<div>
    <label for="itemsPerPage">Count per page:</label>
    <select id="itemsPerPage" onchange="changeItemsPerPage()">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
    </select>
</div>

<table id="getListPlayers">
    <thead>
    <tr class="rTr">
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<div class="pagination" id="pagination"></div>

<script>
    let currentPage = 1;
    let itemsPerPage = 3;
    let totalItems = 0;

    function fetchTotalItems() {
        fetch('/rest/players/count')
            .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
            .then(data => {
            totalItems = data;
            updatePaginationButtons();
            fetchData(currentPage);
        })
            .catch(error => {
            console.error('Error fetching total items: ', error);
        });
    }

    function fetchData(page = 1) {
        fetch(`/rest/players?pageNumber=${page - 1}&pageSize=${itemsPerPage}`)
            .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
            .then(data => {
            const tableBody = document.querySelector('#getListPlayers tbody');
            tableBody.innerHTML = '';

            data.forEach(player => {
                const row = `
                <tr>
                    <td>${player.id}</td>
                    <td>${player.name}</td>
                    <td>${player.title}</td>
                    <td>${player.race}</td>
                    <td>${player.profession}</td>
                    <td>${player.level}</td>
                    <td>${new Date(player.birthday).toLocaleDateString()}</td>
                    <td>${player.banned}</td>
                    <td class="button-cell"><button class="buttonIcon"><img src="/img/edit.png" alt="Edit" onclick="editPlayer(${player.id})"></button></td>
                    <td class="button-cell"><button class="buttonIcon"><img src="/img/delete.png" alt="Delete" onclick="deletePlayer(${player.id})"></button></td>
                </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
            updatePaginationButtons(data.totalPages);
        })
            .catch(error => {
            console.error('Error receiving data: ', error);
        });
    }

    function updatePaginationButtons() {
        const paginationContainer = document.getElementById('pagination');
        paginationContainer.innerHTML = '';

        const lable = document.createElement('lable');
        lable.textContent = 'Pages: ';
        paginationContainer.appendChild(lable);

        const totalPages = Math.ceil(totalItems / itemsPerPage);

        if(totalPages > 1){
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => {
                    currentPage = i;
                    fetchData(currentPage);
                    setActivePageButton(i);
                };

                if (i === currentPage) {
                    button.classList.add('active');
                }

                paginationContainer.appendChild(button);
            }
        }
    }

    function setActivePageButton(activePage) {
        const paginationContainer = document.getElementById('pagination');
        const buttons = paginationContainer.querySelectorAll('button');
        buttons.forEach(button => {
            if (parseInt(button.textContent) === activePage) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }

    function changeItemsPerPage() {
        const select = document.getElementById('itemsPerPage');
        itemsPerPage = parseInt(select.value);
        currentPage = 1;
    }

    function deletePlayer(id) {
        fetch(`/rest/players/${id}`, {
            method: 'DELETE'
        })
            .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            fetchData(currentPage);
        })
            .catch(error => {
            console.error('Error deleting player:', error);
        });
    }

    function editPlayer(id) {
        console.log(`Edit player with id: ${id}`);
    }

    fetchTotalItems();

</script>
</body>
</html>